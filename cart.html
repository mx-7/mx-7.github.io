<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Cache buster: v2.1 -->
    <title>Shopping Cart - Lafa Restaurant</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/animations.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/custom.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@abdulrysr/saudi-riyal-new-symbol-font/style.css"
    />
    <style>
      .bg-light-gray {
        background-color: #000000;
        color: #ffffff;
      }
      .bg-light-gray a {
        color: #ffffff;
      }
      .bg-light-gray a:hover {
        color: #cccccc;
      }
      .bg-light-gray h3,
      .bg-light-gray h4,
      .bg-light-gray p,
      .bg-light-gray li {
        color: #ffffff;
      }
      .cart-container {
        min-height: 70vh;
        padding-top: 100px;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #8b5cf6;
      }
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .quantity-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .quantity-btn:hover {
        background-color: #f3f4f6;
        border-color: #8b5cf6;
      }
      .summary-box {
        background-color: #f3f4f6;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
      }
      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 1rem;
      }
      .summary-total {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid #d1d5db;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
      }
      @media (max-width: 767px) {
        #avatar-container {
          display: none;
        }
      }
      #mobile-avatar-container {
        display: none;
        align-items: center;
        justify-content: center;
      }
      @media (max-width: 767px) {
        #mobile-avatar-container {
          display: flex;
          margin-left: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="root">
      <header
        class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 bg-white py-3 shadow-md"
      >
        <div class="container mx-auto px-4">
          <div class="flex items-center justify-between">
            <a
              href="index.html"
              class="text-2xl md:text-3xl font-bold text-purple-600 px-2 hover:opacity-80 transition-colors"
            >
              lafa restaurant
            </a>
            <nav class="hidden md:flex items-center gap-3">
              <div id="avatar-container"></div>
              <button
                id="logoutBtn"
                class="px-5 py-2 rounded-2xl bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300"
              >
                Logout
              </button>
            </nav>
            <button
              id="mobileLogoutBtn"
              class="md:hidden px-4 py-2 bg-purple-500 text-white rounded-2xl hover:bg-purple-600 transition-all duration-300"
            >
              Logout
            </button>
            <div id="mobile-avatar-container" class="md:hidden"></div>
          </div>
        </div>
      </header>

      <main class="container mx-auto px-4 cart-container">
        <h1 class="text-4xl font-bold text-gray-800 mb-8">Shopping Cart</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Cart Items -->
          <div class="lg:col-span-2">
            <div id="cartItemsContainer" class="space-y-4">
              <div class="text-center py-8 text-gray-500">
                <i class="bx bx-shopping-bag text-5xl mb-4"></i>
                <p class="text-lg">Your cart is empty</p>
                <a
                  href="menu.html"
                  class="mt-4 inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                >
                  Continue Shopping
                </a>
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div id="orderSummaryContainer">
            <div class="summary-box sticky top-24">
              <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Summary</h2>
              
              <div class="summary-row">
                <span class="text-gray-600">Subtotal:</span>
                <span id="subtotal" class="font-semibold text-gray-800">
                  <span class="icon-saudi_riyal">&#xea;</span>0.00
                </span>
              </div>

              <div class="summary-row">
                <span class="text-gray-600">Tax (15%):</span>
                <span id="tax" class="font-semibold text-gray-800">
                  <span class="icon-saudi_riyal">&#xea;</span>0.00
                </span>
              </div>

              <div class="summary-total">
                <span>Total:</span>
                <span id="total" class="text-purple-600">
                  <span class="icon-saudi_riyal">&#xea;</span>0.00
                </span>
              </div>

              <button
                id="payWithCreditBtn"
                class="w-full mt-6 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                disabled
              >
                <i class="bx bx-credit-card"></i>
                Pay with Credit Card
              </button>

              <button
                id="payWithAppleBtn"
                class="w-full mt-3 px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-900 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                disabled
              >
                <i class="bx bxl-apple"></i>
                Pay with Apple Pay
              </button>

              <a
                href="menu.html"
                class="w-full mt-3 block text-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
              >
                Continue Shopping
              </a>
            </div>
          </div>
        </div>

        <!-- Preparing Orders -->
        <div id="preparingOrdersSection" class="mt-8 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Preparing Orders</h2>
          <div id="preparingOrders" class="space-y-2">
            <!-- Preparing orders will be loaded here -->
            <p class="text-gray-500 text-center py-4">No preparing orders</p>
          </div>
        </div>

        <!-- Order History -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Order History</h2>
          <div id="orderHistory" class="space-y-2">
            <!-- Orders will be loaded here -->
            <p class="text-gray-500 text-center py-4">No orders yet</p>
          </div>
        </div>
      </main>

      <footer class="bg-light-gray mt-20">
        <div class="container mx-auto px-4 py-10">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
              <h3 class="text-lg font-semibold mb-4">About Lafa</h3>
              <ul class="space-y-2 text-sm">
                <li><a href="about-us.html" class="hover:opacity-80">About Us</a></li>
                <li><a href="#" class="hover:opacity-80">Blog</a></li>
                <li><a href="#" class="hover:opacity-80">Careers</a></li>
              </ul>
            </div>
            <div>
              <h3 class="text-lg font-semibold mb-4">Support</h3>
              <ul class="space-y-2 text-sm">
                <li><a href="help-center.html" class="hover:opacity-80">Help Center</a></li>
                <li><a href="#" class="hover:opacity-80">Contact Us</a></li>
                <li><a href="#" class="hover:opacity-80">FAQ</a></li>
              </ul>
            </div>
            <div>
              <h3 class="text-lg font-semibold mb-4">Legal</h3>
              <ul class="space-y-2 text-sm">
                <li><a href="terms-and-conditions.html" class="hover:opacity-80">Terms & Conditions</a></li>
                <li><a href="privacy-policy.html" class="hover:opacity-80">Privacy Policy</a></li>
                <li><a href="cancellation-policy.html" class="hover:opacity-80">Cancellation Policy</a></li>
              </ul>
            </div>
            <div>
              <h3 class="text-lg font-semibold mb-4">Follow Us</h3>
              <div class="flex gap-4">
                <a href="#" class="hover:opacity-80"><i class="bx bxl-facebook text-xl"></i></a>
                <a href="#" class="hover:opacity-80"><i class="bx bxl-twitter text-xl"></i></a>
                <a href="#" class="hover:opacity-80"><i class="bx bxl-instagram text-xl"></i></a>
              </div>
            </div>
          </div>
          <div class="border-t border-gray-700 pt-8 text-center">
            <p>&copy; 2025 Lafa Restaurant. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://oscrktdwatdnkzgcupgh.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zY3JrdGR3YXRkbmt6Z2N1cGdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NTYwMDAsImV4cCI6MjA2MTQzMjAwMH0.zUHA_KjhPsUYpOjzybACn1si_SRSAf7BiJPqjgV2ThE";
      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>
    <script src="js/supabase.js"></script>
    <script>
      let currentUser = null;
      let cartData = null;

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const user = await checkUser(true);
          if (!user) {
            return;
          }
          currentUser = user;
          updateAuthButtons();
          loadCart();
          loadOrderHistory();
        } catch (error) {
          console.error("Error in cart page:", error);
        }
      });

      function updateAuthButtons() {
        const logoutBtn = document.getElementById("logoutBtn");
        const mobileLogoutBtn = document.getElementById("mobileLogoutBtn");

        async function signOut() {
          try {
            await window.supabase.auth.signOut();
            window.location.href = "logindex.html";
          } catch (error) {
            console.error("Logout error:", error);
            window.location.href = "logindex.html";
          }
        }

        if (currentUser) {
          logoutBtn.textContent = "Logout";
          mobileLogoutBtn.textContent = "Logout";
          logoutBtn.addEventListener("click", signOut);
          mobileLogoutBtn.addEventListener("click", signOut);

          const avatarUrl = window.userAvatarUrl && window.userAvatarUrl.trim() !== "" ? window.userAvatarUrl : "";
          
          const desktopAvatarBtn = window.createAvatarButton(avatarUrl, "profile.html", false);
          const desktopContainer = document.getElementById("avatar-container");
          if (desktopContainer) {
            desktopContainer.appendChild(desktopAvatarBtn.element);
          }
          window.avatarButtonRef = desktopAvatarBtn;

          const mobileAvatarBtn = window.createAvatarButton(avatarUrl, "profile.html", false);
          const mobileContainer = document.getElementById("mobile-avatar-container");
          if (mobileContainer) {
            mobileContainer.appendChild(mobileAvatarBtn.element);
          }
          window.mobileAvatarButtonRef = mobileAvatarBtn;
        } else {
          logoutBtn.textContent = "Login";
          mobileLogoutBtn.textContent = "Login";
          logoutBtn.addEventListener("click", function () {
            window.location.href = "logindex.html";
          });
          mobileLogoutBtn.addEventListener("click", function () {
            window.location.href = "logindex.html";
          });
        }
      }

      async function loadCart() {
        try {
          if (!currentUser) {
            console.error("User not authenticated");
            return;
          }

          // Get or create cart
          let { data: cart, error: cartError } = await window.supabase
            .from("carts")
            .select("id")
            .eq("user_id", currentUser.id)
            .single();

          if (cartError || !cart) {
            // Create new cart
            const { data: newCart, error: createError } = await window.supabase
              .from("carts")
              .insert([{ user_id: currentUser.id }])
              .select()
              .single();

            if (createError) {
              console.error("Error creating cart:", createError);
              return;
            }
            cart = newCart;
          }

          cartData = cart;

          // Get cart items with hotel details
          const { data: items, error: itemsError } = await window.supabase
            .from("cart_items")
            .select(`
              id,
              hotel_id,
              quantity,
              price,
              hotels:hotel_id(id, name, description)
            `)
            .eq("cart_id", cart.id);

          if (itemsError) {
            console.error("Error loading cart items:", itemsError);
            return;
          }

          displayCart(items || []);
          updateCartSummary(items || []);
        } catch (error) {
          console.error("Error in loadCart:", error);
        }
      }

      function displayCart(items) {
        const container = document.getElementById("cartItemsContainer");
        const orderSummaryContainer = document.getElementById("orderSummaryContainer");

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="bx bx-shopping-bag text-5xl mb-4"></i>
              <p class="text-lg">Your cart is empty</p>
              <a
                href="menu.html"
                class="mt-4 inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
              >
                Continue Shopping
              </a>
            </div>
          `;
          // Hide Order Summary when cart is empty
          orderSummaryContainer.style.display = "none";
          return;
        }

        // Show Order Summary when cart has items
        orderSummaryContainer.style.display = "block";

        container.innerHTML = items
          .map(
            (item) => `
            <div class="cart-item">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800 text-lg mb-3">${
                  item.hotels.name
                }</h3>
                
                <div class="flex items-center gap-8 justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-24 h-24 bg-gray-300 rounded-lg overflow-hidden cart-image-${item.id}">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-full h-full">
                        <rect fill="#999" width="100" height="100"/>
                        <text x="50" y="50" text-anchor="middle" dy=".3em" fill="white" font-size="12" font-family="Arial">No Image</text>
                      </svg>
                    </div>
                    <p class="text-gray-600 font-semibold flex items-center text-sm">
                      <span class="icon-saudi_riyal" style="display: inline-block; margin-right: 2px;">&#xea;</span>
                      <span>${item.price.toFixed(2)}</span>
                    </p>
                  </div>

                  <div class="flex items-center gap-8">
                    <div class="quantity-control">
                      <button class="quantity-btn" onclick="decreaseQuantity(${
                        item.id
                      })">−</button>
                      <span class="w-8 text-center font-semibold">${
                        item.quantity
                      }</span>
                      <button class="quantity-btn" onclick="increaseQuantity(${
                        item.id
                      })">+</button>
                    </div>

                    <p class="font-semibold text-purple-600 w-20 text-right flex items-center justify-end text-lg">
                      <span class="icon-saudi_riyal" style="display: inline-block; margin-right: 4px;">&#xea;</span>
                      <span>${(item.price * item.quantity).toFixed(2)}</span>
                    </p>

                    <button
                      onclick="removeFromCart(${item.id})"
                      class="text-red-600 hover:text-red-800 transition-colors text-2xl"
                    >
                      <i class="bx bx-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `
          )
          .join("");
        
        // Load images for each item
        items.forEach(item => {
          loadCartItemImage(item.id, item.hotel_id);
        });
      }

      async function loadCartItemImage(cartItemId, hotelId) {
        try {
          const { data, error } = await window.supabase
            .from("hotel_images")
            .select("image_url")
            .eq("hotel_id", hotelId)
            .eq("is_main", true)
            .limit(1);

          if (error || !data || data.length === 0) {
            console.log("No image found for hotel", hotelId);
            return;
          }

          const imageUrl = data[0].image_url;
          const imageContainer = document.querySelector(`.cart-image-${cartItemId}`);
          
          if (imageContainer && imageUrl) {
            imageContainer.innerHTML = `<img src="${imageUrl}" alt="Dish image" class="w-full h-full object-cover">`;
          }
        } catch (error) {
          console.error("Error loading cart item image:", error);
        }
      }

      function updateCartSummary(items) {
        const subtotal = items.reduce(
          (sum, item) => sum + (item.price * item.quantity / 1.15),
          0
        );
        const taxAmount = subtotal * 0.15;
        const total = subtotal + taxAmount;

        document.getElementById("subtotal").innerHTML =
          `<span class="icon-saudi_riyal" style="display: inline-block; margin-right: 2px;">&#xea;</span><span>${subtotal.toFixed(2)}</span>`;
        document.getElementById("tax").innerHTML =
          `<span class="icon-saudi_riyal" style="display: inline-block; margin-right: 2px;">&#xea;</span><span>${taxAmount.toFixed(2)}</span>`;
        document.getElementById("total").innerHTML =
          `<span class="icon-saudi_riyal" style="display: inline-block; margin-right: 2px;">&#xea;</span><span>${total.toFixed(2)}</span>`;

        const creditCardBtn = document.getElementById("payWithCreditBtn");
        const applePayBtn = document.getElementById("payWithAppleBtn");
        creditCardBtn.disabled = items.length === 0;
        applePayBtn.disabled = items.length === 0;
      }

      async function increaseQuantity(cartItemId) {
        try {
          const { data: item, error: fetchError } = await window.supabase
            .from("cart_items")
            .select("quantity, price")
            .eq("id", cartItemId)
            .single();

          if (fetchError) {
            console.error("Error fetching item:", fetchError);
            return;
          }

          const { error: updateError } = await window.supabase
            .from("cart_items")
            .update({ quantity: item.quantity + 1 })
            .eq("id", cartItemId);

          if (updateError) {
            console.error("Error updating quantity:", updateError);
            return;
          }

          loadCart();
        } catch (error) {
          console.error("Error in increaseQuantity:", error);
        }
      }

      async function decreaseQuantity(cartItemId) {
        try {
          const { data: item, error: fetchError } = await window.supabase
            .from("cart_items")
            .select("quantity")
            .eq("id", cartItemId)
            .single();

          if (fetchError) {
            console.error("Error fetching item:", fetchError);
            return;
          }

          if (item.quantity <= 1) {
            removeFromCart(cartItemId);
            return;
          }

          const { error: updateError } = await window.supabase
            .from("cart_items")
            .update({ quantity: item.quantity - 1 })
            .eq("id", cartItemId);

          if (updateError) {
            console.error("Error updating quantity:", updateError);
            return;
          }

          loadCart();
        } catch (error) {
          console.error("Error in decreaseQuantity:", error);
        }
      }

      async function removeFromCart(cartItemId) {
        try {
          const { error } = await window.supabase
            .from("cart_items")
            .delete()
            .eq("id", cartItemId);

          if (error) {
            console.error("Error removing item:", error);
            return;
          }

          loadCart();
        } catch (error) {
          console.error("Error in removeFromCart:", error);
        }
      }

      async function loadOrderHistory() {
        try {
          if (!currentUser) return;

          const { data: orders, error } = await window.supabase
            .from("orders")
            .select("id, status, created_at, parking_lot_id, parking_lots!fk_parking_lot(spot_number)")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false })
            .limit(10);

          if (error) {
            console.error("Error loading order history:", error);
            return;
          }

          const statusColors = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'confirmed': 'bg-blue-100 text-blue-800',
            'preparing': 'bg-orange-500 text-white font-bold',
            'ready': 'bg-green-100 text-green-800',
            'completed': 'bg-green-500 text-white font-bold',
            'cancelled': 'bg-red-100 text-red-800'
          };

          // Separate preparing orders from history orders
          const preparingOrders = orders?.filter(o => o.status === 'preparing') || [];
          const historyOrders = orders?.filter(o => o.status !== 'preparing') || [];

          // Handle Preparing Orders section
          const preparingDiv = document.getElementById("preparingOrders");
          
          if (preparingOrders.length > 0) {
            let preparingHtml = '';
            preparingOrders.forEach(order => {
              const date = new Date(order.created_at).toLocaleDateString();
              const orderNumber = generateOrderNumber(order.id);
              const parkingNumber = order.parking_lots?.spot_number || "—";
              
              let statusStyle = '';
              if (order.status === 'preparing') {
                statusStyle = 'style="background-color: #f97316; color: white;"';
              } else if (order.status === 'completed') {
                statusStyle = 'style="background-color: #22c55e; color: white;"';
              }
              
              preparingHtml += `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                  <div class="flex-1">
                    <p class="text-gray-800"><strong>Order #${orderNumber}</strong> • ${date}</p>
                  </div>
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold" ${statusStyle}>
                    ${order.status}
                  </span>
                  <div class="w-20 text-right text-gray-700 text-sm font-semibold">Lot: ${parkingNumber}</div>
                </div>
              `;
            });
            preparingDiv.innerHTML = preparingHtml;
          } else {
            preparingDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No preparing orders</p>';
          }

          // Handle Order History section
          const orderHistoryDiv = document.getElementById("orderHistory");
          
          if (!historyOrders || historyOrders.length === 0) {
            orderHistoryDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No orders yet</p>';
            return;
          }

          let html = '';
          historyOrders.forEach(order => {
            const date = new Date(order.created_at).toLocaleDateString();
            const orderNumber = generateOrderNumber(order.id);
            const parkingNumber = order.parking_lots?.spot_number || "—";
            
            let statusStyle = '';
            if (order.status === 'preparing') {
              statusStyle = 'style="background-color: #f97316; color: white;"';
            } else if (order.status === 'completed') {
              statusStyle = 'style="background-color: #22c55e; color: white;"';
            }
            
            html += `
              <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                <div class="flex-1">
                  <p class="text-gray-800"><strong>Order #${orderNumber}</strong> • ${date}</p>
                </div>
                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold" ${statusStyle}>
                  ${order.status}
                </span>
                <div class="w-20 text-right text-gray-700 text-sm font-semibold">Lot: ${parkingNumber}</div>
              </div>
            `;
          });

          orderHistoryDiv.innerHTML = html;
        } catch (error) {
          console.error("Error in loadOrderHistory:", error);
        }
      }

      function generateOrderNumber(orderId) {
        // Generate order number: 6-digit sequential based on ID
        // Start from 100000 and add the orderId for sequential numbers
        const orderNum = (100000 + orderId).toString().slice(-6);
        return orderNum;
      }

      async function processPayWithCreditCard() {
        try {
          console.log("processPayWithCreditCard called");
          console.log("cartData:", cartData);
          
          if (!cartData || !cartData.id) {
            alert("Cart data not loaded. Please refresh the page.");
            return;
          }

          // Get cart items
          const { data: items, error: itemsError } = await window.supabase
            .from("cart_items")
            .select("hotel_id, quantity, price")
            .eq("cart_id", cartData.id);

          console.log("Items fetched:", items, "Error:", itemsError);

          if (itemsError || !items || items.length === 0) {
            alert("Your cart is empty");
            return;
          }

          // Get hotel names for items
          const hotelIds = items.map(item => item.hotel_id);
          const { data: hotels, error: hotelError } = await window.supabase
            .from("hotels")
            .select("id, name")
            .in("id", hotelIds);

          console.log("Hotels fetched:", hotels, "Error:", hotelError);

          const hotelMap = {};
          if (hotels) {
            hotels.forEach(hotel => {
              hotelMap[hotel.id] = hotel.name;
            });
          }

          // Calculate totals
          const subtotal = items.reduce(
            (sum, item) => sum + (item.price * item.quantity / 1.15),
            0
          );
          const taxAmount = subtotal * 0.15;
          const total = subtotal + taxAmount;

          // Prepare order data with hotel names
          const itemsWithNames = items.map(item => ({
            hotel_id: item.hotel_id,
            hotel_name: hotelMap[item.hotel_id] || "Unknown Hotel",
            quantity: item.quantity,
            price: item.price,
            total: item.price * item.quantity
          }));

          // Store order data in sessionStorage
          const orderData = {
            items: itemsWithNames,
            subtotal: subtotal,
            tax: taxAmount,
            total: total,
            cart_id: cartData.id
          };

          console.log("Order data prepared:", orderData);
          sessionStorage.setItem("pendingOrderData", JSON.stringify(orderData));
          console.log("Order data stored in sessionStorage");

          // Redirect to credit card payment page
          console.log("Redirecting to credit-card-payment.html");
          window.location.href = "credit-card-payment.html";
        } catch (error) {
          console.error("Error in processPayWithCreditCard:", error);
          alert("An error occurred while preparing your payment: " + error.message);
        }
      }

      async function processPayWithApplePay() {
        try {
          // Get cart items
          const { data: items, error: itemsError } = await window.supabase
            .from("cart_items")
            .select("hotel_id, quantity, price")
            .eq("cart_id", cartData.id);

          if (itemsError || !items || items.length === 0) {
            alert("Your cart is empty");
            return;
          }

          const subtotal = items.reduce(
            (sum, item) => sum + (item.price * item.quantity / 1.15),
            0
          );
          const taxAmount = subtotal * 0.15;
          const total = subtotal + taxAmount;

          // Create order
          const { data: order, error: orderError } = await window.supabase
            .from("orders")
            .insert([
              {
                user_id: currentUser.id,
                total_amount: total,
                status: "preparing",
              },
            ])
            .select()
            .single();

          if (orderError) {
            console.error("Error creating order:", orderError);
            alert("Failed to create order");
            return;
          }

          // Create order items
          const orderItems = items.map((item) => ({
            order_id: order.id,
            hotel_id: item.hotel_id,
            quantity: item.quantity,
            price: item.price,
          }));

          const { error: itemInsertError } = await window.supabase
            .from("order_items")
            .insert(orderItems);

          if (itemInsertError) {
            console.error("Error creating order items:", itemInsertError);
            alert("Failed to create order items");
            return;
          }

          // Clear cart items
          const { error: clearError } = await window.supabase
            .from("cart_items")
            .delete()
            .eq("cart_id", cartData.id);

          if (clearError) {
            console.error("Error clearing cart:", clearError);
          }

          // For Apple Pay orders (completed), assign parking if available
          let parkingSpotNumber = null;
          try {
            // Check if user already has parking
            const { data: userParking } = await window.supabase
              .from("parking_lots")
              .select("id, spot_number")
              .eq("user_id", currentUser.id)
              .limit(1);

            let parkingLotId = null;

            if (userParking && userParking.length > 0) {
              // Reuse existing parking
              parkingLotId = userParking[0].id;
              parkingSpotNumber = userParking[0].spot_number;
            } else {
              // Get first available parking spot
              const { data: availableParking } = await window.supabase
                .from("parking_lots")
                .select("id, spot_number")
                .eq("is_available", true)
                .is("user_id", null)
                .order("spot_number", { ascending: true })
                .limit(1);

              if (availableParking && availableParking.length > 0) {
                parkingLotId = availableParking[0].id;
                parkingSpotNumber = availableParking[0].spot_number;
                
                // Assign parking
                await window.supabase
                  .from("parking_lots")
                  .update({
                    is_available: false,
                    user_id: currentUser.id,
                    order_id: order.id,
                    updated_at: new Date().toISOString()
                  })
                  .eq("id", parkingLotId);
              }
            }

            // Update order with parking_lot_id if assigned
            if (parkingLotId) {
              await window.supabase
                .from("orders")
                .update({ parking_lot_id: parkingLotId })
                .eq("id", order.id);
            }
          } catch (parkingError) {
            console.error("Error assigning parking for Apple Pay:", parkingError);
          }

          // Show success message overlay
          const orderNumber = generateOrderNumber(order.id);
          const successOverlay = document.createElement("div");
          successOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
          `;

          const successBox = document.createElement("div");
          successBox.style.cssText = `
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
          `;

          const parkingDisplay = parkingSpotNumber ? `<p style="color: #666; margin-bottom: 12px; padding: 10px; background: #f0f9ff; border-radius: 8px; font-size: 18px;"><strong>Parking Lot: ${parkingSpotNumber}</strong></p>` : '';

          successBox.innerHTML = `
            <div style="font-size: 48px; color: #10b981; margin-bottom: 20px;">✓</div>
            <h2 style="color: #333; margin-bottom: 10px; font-size: 24px;">Payment Successful!</h2>
            <p style="color: #666; margin-bottom: 8px;">Order #<strong>${orderNumber}</strong></p>
            ${parkingDisplay}
            <p style="color: #666;">Your order has been confirmed and will be ready soon.</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;">Back to Cart</button>
          `;

          successOverlay.appendChild(successBox);
          document.body.appendChild(successOverlay);
        } catch (error) {
          console.error("Error in processPayWithApplePay:", error);
          alert("An error occurred while processing your order");
        }
      }

      document.getElementById("payWithCreditBtn").addEventListener("click", async function () {
        console.log("Pay with Credit Card clicked");
        console.log("Button element:", this);
        console.log("cartData:", cartData);
        await processPayWithCreditCard();
      });

      document.getElementById("payWithAppleBtn").addEventListener("click", async function () {
        console.log("Pay with Apple Pay clicked");
        await processPayWithApplePay();
      });
    </script>
  </body>
</html>
